import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

// Carregar vari√°veis de ambiente
dotenv.config();

// Configura√ß√£o do Supabase
const supabaseUrl = process.env.SUPABASE_URL || 'https://niakqdolcdwxtrkbqmdi.supabase.co';
const supabaseKey = process.env.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pYWtxZG9sY2R3eHRya2JxbWRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxODI1NTksImV4cCI6MjA2NTc1ODU1OX0.90ihAk2geP1JoHIvMj_pxeoMe6dwRwH-rBbJwbFeomw';

const supabase = createClient(supabaseUrl, supabaseKey);

// Simular os m√©todos do LLMOrchestratorService
function calculateSimilarity(str1, str2) {
  if (str1 === str2) return 1.0;
  if (str1.length === 0 || str2.length === 0) return 0.0;
  
  // Dividir em palavras
  const words1 = new Set(str1.split(/\s+/));
  const words2 = new Set(str2.split(/\s+/));
  
  // Filtrar palavras muito comuns que n√£o indicam duplica√ß√£o
  const commonWords = new Set(['a', 'o', 'e', 'de', 'da', 'do', 'em', 'para', 'com', 'que', 'se', 'n√£o', '√©', 's√£o', 'tem', 'est√°', 'pode', 'posso', 'te', 'voc√™', 'nossa', 'nossos', 'sua', 'seus']);
  
  const filteredWords1 = new Set([...words1].filter(word => !commonWords.has(word.toLowerCase())));
  const filteredWords2 = new Set([...words2].filter(word => !commonWords.has(word.toLowerCase())));
  
  // Se ap√≥s filtrar n√£o h√° palavras significativas, usar compara√ß√£o original
  if (filteredWords1.size === 0 && filteredWords2.size === 0) {
    const intersection = new Set([...words1].filter(x => words2.has(x)));
    const union = new Set([...words1, ...words2]);
    return intersection.size / union.size;
  }
  
  // Calcular interse√ß√£o e uni√£o das palavras filtradas
  const intersection = new Set([...filteredWords1].filter(x => filteredWords2.has(x)));
  const union = new Set([...filteredWords1, ...filteredWords2]);
  
  return intersection.size / union.size;
}

function removeDuplicateContent(text) {
  // Dividir o texto em frases
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
  
  // Array para armazenar frases √∫nicas
  const uniqueSentences = [];
  const seenPhrases = new Set();
  
  for (const sentence of sentences) {
    const cleanSentence = sentence.trim();
    if (cleanSentence.length === 0) continue;
    
    // Normalizar a frase para compara√ß√£o (remover espa√ßos extras, converter para min√∫sculas)
    const normalizedSentence = cleanSentence.toLowerCase().replace(/\s+/g, ' ').trim();
    
    // Verificar se a frase j√° foi vista (com toler√¢ncia para pequenas varia√ß√µes)
    const isDuplicate = Array.from(seenPhrases).some(seen => {
      const similarity = calculateSimilarity(normalizedSentence, seen);
      return similarity > 0.9; // Aumentar para 90% de similaridade para ser mais rigoroso
    });
    
    if (!isDuplicate) {
      uniqueSentences.push(cleanSentence);
      seenPhrases.add(normalizedSentence);
    }
  }
  
  // Reconstruir o texto sem duplica√ß√µes
  let result = uniqueSentences.join('. ');
  
  // Garantir que termina com pontua√ß√£o
  if (result && !result.match(/[.!?]$/)) {
    result += '.';
  }
  
  // Limpar espa√ßos extras e quebras de linha
  result = result.replace(/\s+/g, ' ').trim();
  
  return result;
}

function removeGreetingPatterns(text) {
  const patterns = [
    /Ol√°! Sou o .*?assistente virtual.*?Como posso ajud√°-lo hoje\?/gi,
    /Ol√°! Sou o .*?assistente virtual.*?Em que posso ajudar/gi,
    /Ol√°! Sou o .*?assistente virtual.*?Como posso cuidar/gi,
    /Ol√°! Sou o .*?assistente virtual.*?Como posso ajud√°-lo/gi,
    /Ol√°! Sou o .*?assistente virtual.*?Em que posso ajud√°-lo/gi,
    /Ol√°! Sou o .*?assistente virtual.*?Como posso ajudar/gi,
    // Padr√µes mais espec√≠ficos para o caso real
    /Ol√°! Sou o Cardio, assistente virtual da CardioPrime\. Em que posso ajudar voc√™ hoje\?/gi,
    /Ol√°! Sou o Cardio, assistente virtual da CardioPrime\. Como posso cuidar da sua sa√∫de cardiovascular hoje\?/gi,
    /Ol√°! Sou o Cardio, assistente virtual da CardioPrime\. Como posso ajud√°-lo hoje\?/gi
  ];
  
  let cleanText = text;
  patterns.forEach(pattern => {
    cleanText = cleanText.replace(pattern, '');
  });
  
  // Limpar espa√ßos extras e quebras de linha duplicadas
  cleanText = cleanText.replace(/\n\s*\n/g, '\n\n').trim();
  
  // Remover frases soltas que podem ter ficado
  cleanText = cleanText.replace(/^voc√™ hoje\?\s*/gi, '');
  cleanText = cleanText.replace(/^Em que posso ajudar\s*/gi, '');
  cleanText = cleanText.replace(/^Como posso ajud√°-lo\s*/gi, '');
  
  return cleanText;
}

function applyResponseLogic(response, clinicContext, isFirstConversationOfDay, isWithinBusinessHours, userProfile) {
  try {
    // Obter configura√ß√µes do agente
    const agentConfig = clinicContext.agentConfig || {};
    
    console.log('üîß Configura√ß√µes do agente encontradas:', {
      nome: agentConfig.nome,
      saudacao_inicial: agentConfig.saudacao_inicial ? 'CONFIGURADA' : 'N√ÉO CONFIGURADA'
    });
    
    // Se est√° fora do hor√°rio, usar mensagem fora do hor√°rio
    if (!isWithinBusinessHours) {
      const outOfHoursMessage = agentConfig.mensagem_fora_horario || 
        'No momento estamos fora do hor√°rio de atendimento. Retornaremos seu contato no pr√≥ximo hor√°rio comercial.';
      
      console.log('üïí Aplicando mensagem fora do hor√°rio');
      return outOfHoursMessage;
    }

    // Se √© primeira conversa do dia, adicionar sauda√ß√£o inicial
    if (isFirstConversationOfDay) {
      const initialGreeting = agentConfig.saudacao_inicial || 
        `Ol√°! Sou o ${agentConfig.nome || 'Assistente Virtual'}, assistente virtual da ${clinicContext.name}. Como posso ajud√°-lo hoje?`;
      
      console.log('üëã Aplicando sauda√ß√£o inicial:', initialGreeting.substring(0, 50) + '...');
      
      // Personalizar sauda√ß√£o com nome do usu√°rio se dispon√≠vel
      let personalizedGreeting = initialGreeting;
      if (userProfile?.name) {
        personalizedGreeting = initialGreeting.replace('Como posso ajud√°-lo hoje?', `Como posso ajud√°-lo hoje, ${userProfile.name}?`);
      }
      
      // 1. Verificar se j√° tem sauda√ß√£o na resposta do LLM
      const hasGreeting = response.includes('Ol√°! Sou o') || 
                         response.includes('assistente virtual') ||
                         response.includes('Como posso ajud√°-lo') ||
                         response.includes('Em que posso ajudar') ||
                         response.includes('Como posso cuidar');
      
      console.log('üîç Verificando duplica√ß√£o de sauda√ß√£o:', hasGreeting ? 'ENCONTRADA' : 'N√ÉO ENCONTRADA');
      
      if (hasGreeting) {
        // 2. Remover sauda√ß√µes duplicadas da resposta
        const cleanResponse = removeGreetingPatterns(response);
        console.log('üßπ Sauda√ß√£o duplicada removida da resposta');
        return personalizedGreeting + "\n\n" + cleanResponse;
      } else {
        // N√£o tem sauda√ß√£o, adicionar normalmente
        return personalizedGreeting + "\n\n" + response;
      }
    }

    // Para todas as respostas (primeira conversa ou n√£o), verificar duplica√ß√µes gerais
    const cleanedResponse = removeDuplicateContent(response);
    if (cleanedResponse !== response) {
      console.log('üßπ Conte√∫do duplicado removido da resposta');
    }

    return cleanedResponse;
  } catch (error) {
    console.error('‚ùå Erro ao aplicar l√≥gica de resposta:', error);
    return response;
  }
}

async function testGeneralDuplicationFix() {
  console.log('üß™ TESTE: Corre√ß√£o de duplica√ß√µes gerais');
  
  try {
    // Simular contexto da cl√≠nica
    const clinicContext = {
      name: 'CardioPrime',
      agentConfig: {
        nome: 'Cardio',
        saudacao_inicial: 'Ol√°! Sou o Cardio, assistente virtual da CardioPrime. Como posso cuidar da sua sa√∫de cardiovascular hoje?',
        mensagem_despedida: 'Obrigado por escolher nossa cl√≠nica. At√© breve!',
        mensagem_fora_horario: 'No momento estamos fora do hor√°rio de atendimento. Retornaremos seu contato no pr√≥ximo hor√°rio comercial.'
      }
    };

    // Teste 1: Resposta com sauda√ß√£o duplicada (caso real)
    console.log('\nüìù TESTE 1: Resposta com sauda√ß√£o duplicada');
    const responseWithDuplication = `Ol√°! Sou o Cardio, assistente virtual da CardioPrime. Em que posso ajudar voc√™ hoje? Caso tenha alguma d√∫vida sobre nossos servi√ßos ou precise de informa√ß√µes sobre sa√∫de cardiovascular, estou √† disposi√ß√£o para ajudar.`;
    
    const result1 = applyResponseLogic(
      responseWithDuplication, 
      clinicContext, 
      true, // isFirstConversationOfDay
      true, // isWithinBusinessHours
      { name: 'Lucas' }
    );

    console.log('\nüìù RESULTADO TESTE 1:');
    console.log('='.repeat(50));
    console.log(result1);
    console.log('='.repeat(50));

    // Teste 2: Resposta com frases duplicadas
    console.log('\nüìù TESTE 2: Resposta com frases duplicadas');
    const responseWithRepeatedPhrases = `A CardioPrime √© uma cl√≠nica especializada em cardiologia. A CardioPrime oferece servi√ßos de qualidade. A CardioPrime est√° localizada em Blumenau. A CardioPrime tem equipamentos modernos.`;
    
    const result2 = applyResponseLogic(
      responseWithRepeatedPhrases, 
      clinicContext, 
      false, // isFirstConversationOfDay
      true, // isWithinBusinessHours
      { name: 'Lucas' }
    );

    console.log('\nüìù RESULTADO TESTE 2:');
    console.log('='.repeat(50));
    console.log(result2);
    console.log('='.repeat(50));

    // Teste 3: Resposta com frases similares mas n√£o id√™nticas
    console.log('\nüìù TESTE 3: Resposta com frases similares');
    const responseWithSimilarPhrases = `Posso te ajudar com informa√ß√µes sobre nossos servi√ßos. Posso te ajudar com agendamentos. Posso te ajudar com d√∫vidas sobre exames.`;
    
    const result3 = applyResponseLogic(
      responseWithSimilarPhrases, 
      clinicContext, 
      false, // isFirstConversationOfDay
      true, // isWithinBusinessHours
      { name: 'Lucas' }
    );

    console.log('\nüìù RESULTADO TESTE 3:');
    console.log('='.repeat(50));
    console.log(result3);
    console.log('='.repeat(50));

    // Teste 4: Resposta normal sem duplica√ß√µes
    console.log('\nüìù TESTE 4: Resposta normal sem duplica√ß√µes');
    const responseNormal = `A CardioPrime oferece consultas cardiovasculares especializadas. Nossos exames incluem ecocardiograma e teste ergom√©trico. Estamos localizados no Hospital Santa Catarina.`;
    
    const result4 = applyResponseLogic(
      responseNormal, 
      clinicContext, 
      false, // isFirstConversationOfDay
      true, // isWithinBusinessHours
      { name: 'Lucas' }
    );

    console.log('\nüìù RESULTADO TESTE 4:');
    console.log('='.repeat(50));
    console.log(result4);
    console.log('='.repeat(50));

    // Verificar se h√° duplica√ß√µes nos resultados
    console.log('\nüîç VERIFICA√á√ÉO DE DUPLICA√á√ïES:');
    
    // Fun√ß√£o para verificar duplica√ß√µes de forma mais inteligente
    function checkForDuplications(text, phrase) {
      const occurrences = text.split(phrase).length - 1;
      return occurrences > 1;
    }
    
    const hasDuplication1 = checkForDuplications(result1, 'Ol√°! Sou o Cardio');
    console.log(`Teste 1 tem duplica√ß√£o? ${hasDuplication1 ? 'SIM' : 'N√ÉO'}`);
    
    const hasDuplication2 = checkForDuplications(result2, 'A CardioPrime');
    console.log(`Teste 2 tem duplica√ß√£o? ${hasDuplication2 ? 'SIM' : 'N√ÉO'}`);
    
    const hasDuplication3 = checkForDuplications(result3, 'Posso te ajudar');
    console.log(`Teste 3 tem duplica√ß√£o? ${hasDuplication3 ? 'SIM' : 'N√ÉO'}`);
    
    const hasDuplication4 = checkForDuplications(result4, 'CardioPrime');
    console.log(`Teste 4 tem duplica√ß√£o? ${hasDuplication4 ? 'SIM' : 'N√ÉO'}`);

    if (!hasDuplication1 && !hasDuplication2 && !hasDuplication3 && !hasDuplication4) {
      console.log('\n‚úÖ SUCESSO: Todas as duplica√ß√µes foram removidas!');
    } else {
      console.log('\n‚ö†Ô∏è ATEN√á√ÉO: Ainda h√° duplica√ß√µes detectadas.');
    }

  } catch (error) {
    console.error('‚ùå Erro no teste:', error);
  }
}

// Executar teste
testGeneralDuplicationFix().then(() => {
  console.log('\n‚úÖ Teste conclu√≠do!');
  process.exit(0);
}).catch(error => {
  console.error('‚ùå Erro:', error);
  process.exit(1);
}); 