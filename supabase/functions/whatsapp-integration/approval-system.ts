
export interface ApprovalRequest {
  id: string;
  type: 'cancel' | 'reschedule' | 'new_appointment';
  phoneNumber: string;
  customerName?: string;
  originalAppointment?: any;
  newAppointmentData?: any;
  reason?: string;
  status: 'pending' | 'approved' | 'rejected';
  createdAt: string;
  requestedBy: string;
}

export class ApprovalSystem {
  static async createApprovalRequest(
    supabase: any,
    request: Partial<ApprovalRequest>
  ): Promise<string> {
    console.log('üìã Criando solicita√ß√£o de aprova√ß√£o:', request);

    try {
      // Salvar solicita√ß√£o no banco
      const approvalId = `apr_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      const { error } = await supabase
        .from('appointment_approval_requests')
        .insert({
          id: approvalId,
          type: request.type,
          phone_number: request.phoneNumber,
          customer_name: request.customerName,
          original_appointment: request.originalAppointment,
          new_appointment_data: request.newAppointmentData,
          reason: request.reason,
          status: 'pending',
          requested_by: 'whatsapp_bot'
        });

      if (error) {
        console.error('‚ùå Erro ao salvar solicita√ß√£o:', error);
        // Continuar mesmo se n√£o conseguir salvar no banco
      }

      // Notificar atendentes (isso seria integrado com sistema de notifica√ß√µes)
      await this.notifyAttendants(supabase, {
        ...request,
        id: approvalId
      } as ApprovalRequest);

      return this.formatApprovalMessage(request);
    } catch (error) {
      console.error('‚ùå Erro no sistema de aprova√ß√£o:', error);
      return `‚úÖ Sua solicita√ß√£o foi registrada e ser√° analisada pela nossa equipe.

üìß Voc√™ ser√° notificado da decis√£o em breve por WhatsApp ou email.

üïê Tempo estimado de resposta: at√© 4 horas √∫teis.`;
    }
  }

  private static async notifyAttendants(
    supabase: any, 
    approval: ApprovalRequest
  ): Promise<void> {
    console.log('üîî Notificando atendentes sobre aprova√ß√£o:', approval.id);

    try {
      // Buscar atendentes com permiss√£o para agendamentos
      const { data: attendants, error } = await supabase
        .from('user_profiles')
        .select('id, name')
        .eq('role', 'admin')
        .eq('status', true);

      if (error || !attendants?.length) {
        console.log('‚ö†Ô∏è Nenhum atendente encontrado para notificar');
        return;
      }

      // Criar notifica√ß√£o no sistema interno
      const notificationData = {
        type: 'appointment_approval',
        title: this.getNotificationTitle(approval),
        message: this.getNotificationMessage(approval),
        approval_id: approval.id,
        priority: approval.type === 'cancel' ? 'high' : 'medium',
        created_at: new Date().toISOString()
      };

      // Salvar notifica√ß√£o para cada atendente
      const notifications = attendants.map(attendant => ({
        ...notificationData,
        user_id: attendant.id
      }));

      await supabase
        .from('internal_notifications')
        .insert(notifications);

      console.log(`‚úÖ ${attendants.length} atendentes notificados`);
    } catch (error) {
      console.error('‚ùå Erro ao notificar atendentes:', error);
    }
  }

  private static getNotificationTitle(approval: ApprovalRequest): string {
    switch (approval.type) {
      case 'cancel':
        return `üö´ Solicita√ß√£o de Cancelamento`;
      case 'reschedule':
        return `üîÑ Solicita√ß√£o de Reagendamento`;
      case 'new_appointment':
        return `üìÖ Novo Agendamento para Aprova√ß√£o`;
      default:
        return `üìã Nova Solicita√ß√£o`;
    }
  }

  private static getNotificationMessage(approval: ApprovalRequest): string {
    const customer = approval.customerName || 'Cliente';
    const phone = approval.phoneNumber?.replace(/\D/g, '') || '';
    
    switch (approval.type) {
      case 'cancel':
        return `${customer} (${phone}) solicitou cancelamento de consulta via WhatsApp.`;
      case 'reschedule':
        return `${customer} (${phone}) solicitou reagendamento de consulta via WhatsApp.`;
      case 'new_appointment':
        return `${customer} (${phone}) fez novo agendamento via WhatsApp que precisa de aprova√ß√£o.`;
      default:
        return `${customer} (${phone}) fez uma solicita√ß√£o via WhatsApp.`;
    }
  }

  private static formatApprovalMessage(request: Partial<ApprovalRequest>): string {
    const baseMessage = `‚úÖ **Solicita√ß√£o registrada com sucesso!**

üìã Sua solicita√ß√£o de **${this.getTypeDescription(request.type!)}** foi enviada para nossa equipe.

üîî **O que acontece agora:**
‚Ä¢ Nossa equipe analisar√° sua solicita√ß√£o
‚Ä¢ Voc√™ receber√° uma resposta em at√© 4 horas √∫teis
‚Ä¢ A confirma√ß√£o ser√° enviada por WhatsApp

‚è∞ **Hor√°rio de atendimento:** Segunda a Sexta, 8h √†s 18h

üìû **Urgente?** Entre em contato por telefone: (XX) XXXX-XXXX`;

    if (request.type === 'cancel') {
      return baseMessage + `\n\n‚ö†Ô∏è **Importante:** Sua consulta ainda est√° marcada at√© a aprova√ß√£o do cancelamento.`;
    }

    return baseMessage;
  }

  private static getTypeDescription(type: string): string {
    switch (type) {
      case 'cancel': return 'cancelamento';
      case 'reschedule': return 'reagendamento';
      case 'new_appointment': return 'agendamento';
      default: return 'solicita√ß√£o';
    }
  }

  static async processApprovalResponse(
    supabase: any,
    approvalId: string,
    decision: 'approved' | 'rejected',
    attendantId: string,
    notes?: string
  ): Promise<boolean> {
    console.log(`‚öñÔ∏è Processando decis√£o de aprova√ß√£o ${approvalId}: ${decision}`);

    try {
      // Atualizar status da aprova√ß√£o
      const { data: approval, error: updateError } = await supabase
        .from('appointment_approval_requests')
        .update({
          status: decision,
          processed_by: attendantId,
          processed_at: new Date().toISOString(),
          notes
        })
        .eq('id', approvalId)
        .select()
        .single();

      if (updateError || !approval) {
        console.error('‚ùå Erro ao atualizar aprova√ß√£o:', updateError);
        return false;
      }

      // Executar a√ß√£o baseada na decis√£o
      if (decision === 'approved') {
        await this.executeApprovedAction(supabase, approval);
      }

      // Notificar cliente via WhatsApp
      await this.notifyCustomer(supabase, approval, decision, notes);

      return true;
    } catch (error) {
      console.error('‚ùå Erro ao processar aprova√ß√£o:', error);
      return false;
    }
  }

  private static async executeApprovedAction(supabase: any, approval: any): Promise<void> {
    console.log(`üéØ Executando a√ß√£o aprovada: ${approval.type}`);

    try {
      switch (approval.type) {
        case 'cancel':
          if (approval.original_appointment?.id) {
            await supabase.functions.invoke('appointment-manager', {
              body: {
                action: 'delete',
                eventId: approval.original_appointment.id
              }
            });
          }
          break;

        case 'reschedule':
          // Cancelar agendamento antigo e criar novo
          if (approval.original_appointment?.id) {
            await supabase.functions.invoke('appointment-manager', {
              body: {
                action: 'delete',
                eventId: approval.original_appointment.id
              }
            });
          }
          
          if (approval.new_appointment_data) {
            await supabase.functions.invoke('appointment-manager', {
              body: {
                action: 'create',
                appointmentData: approval.new_appointment_data
              }
            });
          }
          break;

        case 'new_appointment':
          if (approval.new_appointment_data) {
            await supabase.functions.invoke('appointment-manager', {
              body: {
                action: 'create',
                appointmentData: approval.new_appointment_data
              }
            });
          }
          break;
      }

      console.log(`‚úÖ A√ß√£o ${approval.type} executada com sucesso`);
    } catch (error) {
      console.error(`‚ùå Erro ao executar a√ß√£o ${approval.type}:`, error);
    }
  }

  private static async notifyCustomer(
    supabase: any,
    approval: any,
    decision: 'approved' | 'rejected',
    notes?: string
  ): Promise<void> {
    console.log(`üì± Notificando cliente sobre decis√£o: ${decision}`);

    try {
      const message = this.formatCustomerNotification(approval, decision, notes);
      
      // Enviar mensagem via WhatsApp
      const { sendMessage } = await import('./message-sender.ts');
      await sendMessage(approval.phone_number, message, supabase);

      console.log(`‚úÖ Cliente notificado sobre ${decision}`);
    } catch (error) {
      console.error('‚ùå Erro ao notificar cliente:', error);
    }
  }

  private static formatCustomerNotification(
    approval: any,
    decision: 'approved' | 'rejected',
    notes?: string
  ): string {
    const baseInfo = `üìã **Atualiza√ß√£o da sua solicita√ß√£o**\n\n`;
    
    if (decision === 'approved') {
      let message = baseInfo + `‚úÖ Sua solicita√ß√£o de **${this.getTypeDescription(approval.type)}** foi **APROVADA**!\n\n`;
      
      switch (approval.type) {
        case 'cancel':
          message += `üö´ Sua consulta foi cancelada com sucesso.\n\n`;
          break;
        case 'reschedule':
          message += `üîÑ Sua consulta foi reagendada com sucesso!\n\n`;
          if (approval.new_appointment_data) {
            const newDate = new Date(approval.new_appointment_data.date);
            message += `üìÖ **Nova data:** ${newDate.toLocaleDateString('pt-BR')}\n`;
            message += `üïê **Novo hor√°rio:** ${approval.new_appointment_data.startTime}\n`;
            message += `üë®‚Äç‚öïÔ∏è **Consulta:** ${approval.new_appointment_data.title}\n\n`;
          }
          break;
        case 'new_appointment':
          message += `üìÖ Seu agendamento foi confirmado!\n\n`;
          break;
      }
      
      message += `üéâ Tudo certo! Se precisar de mais alguma coisa, estou aqui para ajudar! üòä`;
      
      if (notes) {
        message += `\n\nüí¨ **Observa√ß√£o da equipe:** ${notes}`;
      }
      
      return message;
    } else {
      let message = baseInfo + `‚ùå Sua solicita√ß√£o de **${this.getTypeDescription(approval.type)}** foi **NEGADA**.\n\n`;
      
      message += `üòî Infelizmente n√£o foi poss√≠vel atender sua solicita√ß√£o desta vez.\n\n`;
      
      if (notes) {
        message += `üí¨ **Motivo:** ${notes}\n\n`;
      }
      
      message += `üìû Para mais informa√ß√µes, entre em contato conosco:\n`;
      message += `‚Ä¢ WhatsApp: Continue a conversa aqui\n`;
      message += `‚Ä¢ Telefone: (XX) XXXX-XXXX\n\n`;
      message += `Estamos aqui para ajudar! üòä`;
      
      return message;
    }
  }
}
