// Gerar QR Code via API
app.post('/api/whatsapp/generate-qr', async (req, res) => {
    try {
        const { agentId } = req.body;
        
        if (!agentId) {
            return res.status(400).json({
                success: false,
                error: 'agentId é obrigatório'
            });
        }

        console.log('Gerando QR Code para agente:', agentId);

        // Desconectar cliente anterior se existir
        if (client) {
            client.destroy();
        }

        // Criar novo cliente
        client = new Client({
            authStrategy: new LocalAuth({
                clientId: 'atendeai-' + agentId,
                dataPath: dataDir
            }),
            puppeteer: {
                headless: true,
                args: [
                    '--no-sandbox',
                    '--disable-setuid-sandbox',
                    '--disable-dev-shm-usage',
                    '--disable-accelerated-2d-canvas',
                    '--no-first-run',
                    '--no-zygote',
                    '--disable-gpu'
                ]
            }
        });

        // Eventos do cliente
        client.on('qr', async (qr) => {
            try {
                qrCode = await qrcode.toDataURL(qr);
                console.log('QR Code gerado com sucesso');
            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
            }
        });

        client.on('ready', () => {
            console.log('Cliente WhatsApp pronto');
            qrCode = null;
        });

        client.on('disconnected', (reason) => {
            console.log('Cliente WhatsApp desconectado:', reason);
            client = null;
            qrCode = null;
        });

        client.on('auth_failure', (msg) => {
            console.error('Falha na autenticação:', msg);
            qrCode = null;
        });

        // Inicializar cliente
        await client.initialize();

        // Aguardar um pouco para o QR Code ser gerado
        await new Promise(resolve => setTimeout(resolve, 2000));

        if (qrCode) {
            res.json({
                success: true,
                message: 'QR Code gerado com sucesso',
                agentId: agentId,
                whatsappNumber: 'temp',
                connectionId: 'temp-' + Date.now(),
                qrCode: qrCode
            });
        } else {
            res.status(500).json({
                success: false,
                error: 'Erro ao gerar QR Code',
                status: 'error'
            });
        }

    } catch (error) {
        console.error('Erro ao gerar QR Code:', error);
        res.status(500).json({
            success: false,
            error: error.message,
            status: 'error'
        });
    }
}); 