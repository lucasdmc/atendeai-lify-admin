#!/bin/bash

echo "üß† IMPLEMENTANDO SISTEMA AI ROBUSTO E INTELIGENTE..."
echo "======================================================"

# Parar o servi√ßo
pm2 stop atendeai-backend

# 1. MELHORAR SERVI√áO DE MEM√ìRIA COM APRESENTA√á√ÉO AUTOM√ÅTICA
cat > /root/atendeai-lify-backend/src/services/ai/conversationMemoryService.js << 'EOF'
class ConversationMemoryService {
  static memoryCache = new Map();

  static async loadMemory(phoneNumber) {
    const existing = this.memoryCache.get(phoneNumber);
    if (existing) {
      return existing;
    }

    return {
      phoneNumber,
      history: [],
      userProfile: {
        phone: phoneNumber,
        lastInteraction: new Date(),
        firstInteraction: new Date(),
        interactionCount: 0,
        name: null,
        email: null,
        preferences: {}
      },
      context: {
        lastIntent: null,
        conversationFlow: [],
        topics: [],
        appointmentData: {},
        frustrationLevel: 0,
        loopCount: 0
      },
      metadata: {
        isFirstConversation: true,
        daysSinceLastInteraction: null,
        totalInteractions: 0,
        averageResponseTime: 0
      }
    };
  }

  static async saveMemory(phoneNumber, memory) {
    this.memoryCache.set(phoneNumber, memory);
    console.log(`üíæ Memory saved for: ${phoneNumber}`);
  }

  static async addInteraction(phoneNumber, userMessage, botResponse, intent) {
    const memory = await this.loadMemory(phoneNumber);
    
    // Adicionar √† hist√≥ria
    memory.history.push({
      role: 'user',
      content: userMessage,
      timestamp: new Date()
    });

    memory.history.push({
      role: 'assistant', 
      content: botResponse,
      timestamp: new Date()
    });

    // Atualizar estat√≠sticas
    memory.userProfile.lastInteraction = new Date();
    memory.userProfile.interactionCount++;
    memory.context.lastIntent = intent;
    memory.metadata.totalInteractions++;
    memory.metadata.isFirstConversation = false;

    // Calcular dias desde √∫ltima intera√ß√£o
    if (memory.history.length > 2) {
      const lastInteraction = memory.history[memory.history.length - 4]?.timestamp;
      if (lastInteraction) {
        const daysDiff = Math.floor((new Date() - new Date(lastInteraction)) / (1000 * 60 * 60 * 24));
        memory.metadata.daysSinceLastInteraction = daysDiff;
      }
    }

    // Manter apenas √∫ltimas 20 intera√ß√µes para performance
    if (memory.history.length > 40) {
      memory.history = memory.history.slice(-40);
    }

    await this.saveMemory(phoneNumber, memory);
  }

  static async shouldIntroduceSelf(phoneNumber) {
    const memory = await this.loadMemory(phoneNumber);
    
    // Primeira conversa
    if (memory.metadata.isFirstConversation) {
      return true;
    }
    
    // Dias desde √∫ltima intera√ß√£o (mais de 3 dias)
    if (memory.metadata.daysSinceLastInteraction && memory.metadata.daysSinceLastInteraction > 3) {
      return true;
    }
    
    // Poucas intera√ß√µes (menos de 3)
    if (memory.metadata.totalInteractions < 3) {
      return true;
    }
    
    return false;
  }

  static async getUserName(phoneNumber) {
    const memory = await this.loadMemory(phoneNumber);
    return memory.userProfile.name;
  }

  static async setUserName(phoneNumber, name) {
    const memory = await this.loadMemory(phoneNumber);
    memory.userProfile.name = name;
    await this.saveMemory(phoneNumber, memory);
    console.log(`üë§ Name saved for ${phoneNumber}: ${name}`);
  }

  static async getConversationContext(phoneNumber) {
    const memory = await this.loadMemory(phoneNumber);
    return {
      isFirstConversation: memory.metadata.isFirstConversation,
      daysSinceLastInteraction: memory.metadata.daysSinceLastInteraction,
      userName: memory.userProfile.name,
      totalInteractions: memory.metadata.totalInteractions,
      lastIntent: memory.context.lastIntent
    };
  }
}

module.exports = ConversationMemoryService;
EOF

# 2. MELHORAR SERVI√áO DE RECONHECIMENTO DE INTEN√á√ïES (EXTREMAMENTE ROBUSTO)
cat > /root/atendeai-lify-backend/src/services/ai/intentRecognitionService.js << 'EOF'
class IntentRecognitionService {
  static INTENT_KEYWORDS = {
    // AGENDAMENTOS
    APPOINTMENT_CREATE: ['agendar', 'marcar', 'consulta', 'agendamento', 'hor√°rio', 'marca√ß√£o', 'agenda'],
    APPOINTMENT_RESCHEDULE: ['remarcar', 'alterar', 'mudar', 'reagendar', 'trocar', 'modificar'],
    APPOINTMENT_CANCEL: ['cancelar', 'desmarcar', 'cancelamento', 'desmarca√ß√£o'],
    APPOINTMENT_LIST: ['minhas consultas', 'meus agendamentos', 'consultas marcadas', 'agendamentos'],
    
    // INFORMA√á√ïES
    INFO_HOURS: ['hor√°rio', 'funcionamento', 'aberto', 'fechado', 'hor√°rios', 'atendimento', 'expediente'],
    INFO_LOCATION: ['endere√ßo', 'localiza√ß√£o', 'onde', 'rua', 'bairro', 'cidade', 'como chegar', 'mapa'],
    INFO_SERVICES: ['servi√ßos', 'especialidades', 'm√©dicos', 'tratamentos', 'procedimentos', 'exames'],
    INFO_DOCTORS: ['doutor', 'm√©dico', 'especialista', 'dr', 'dra', 'profissional'],
    INFO_PRICES: ['pre√ßo', 'valor', 'quanto custa', 'conv√™nio', 'plano', 'custo', 'pagamento'],
    
    // CONVERSA√á√ÉO
    GREETING: ['ol√°', 'oi', 'bom dia', 'boa tarde', 'boa noite', 'hey', 'fala'],
    FAREWELL: ['tchau', 'at√© logo', 'obrigado', 'valeu', 'at√© mais', 'adeus', 'bye'],
    THANKS: ['obrigado', 'valeu', 'agrade√ßo', 'obrigada', 'grato', 'gratid√£o'],
    HOW_ARE_YOU: ['tudo bem', 'como vai', 'como est√°', 'tudo bom', 'beleza', 'tranquilo'],
    
    // PERGUNTAS SOBRE NOME
    NAME_QUESTION: ['qual meu nome', 'meu nome', 'quem sou eu', 'como me chamo', 'sabe meu nome'],
    BOT_NAME_QUESTION: ['qual seu nome', 'como voc√™ se chama', 'quem √© voc√™', 'seu nome', 'como te chamas'],
    BOT_CAPABILITIES: ['o que voc√™ faz', 'para que serve', 'suas capacidades', 'pode fazer', 'funcionalidades', 'habilidades'],
    BOT_IDENTITY: ['voc√™ √©', '√© um bot', '√© humano', '√© real', '√© artificial'],
    
    // TESTE E CONVERSA√á√ÉO
    CONVERSATION_TEST: ['testar', 'conversa√ß√£o', 'capacidade', 'intelig√™ncia', 'teste', 'prova'],
    SMALL_TALK: ['clima', 'tempo', 'futebol', 'm√∫sica', 'filme', 's√©rie', 'hobby', 'passatempo'],
    
    // SUPORTE
    HUMAN_HANDOFF: ['humano', 'pessoa', 'atendente', 'operador', 'real', 'f√≠sico', 'vivo'],
    COMPLAINT: ['reclama√ß√£o', 'problema', 'erro', 'falha', 'defeito', 'insatisfeito'],
    PRAISE: ['elogio', 'parab√©ns', 'excelente', '√≥timo', 'maravilhoso', 'fant√°stico'],
    
    // URG√äNCIA
    EMERGENCY: ['emerg√™ncia', 'urgente', 'grave', 'cr√≠tico', 'socorro', 'ajuda'],
    URGENT_APPOINTMENT: ['urgente', 'emerg√™ncia', 'grave', 'cr√≠tico', 'imediato']
  };

  static async recognizeIntent(message) {
    const lowerMessage = message.toLowerCase();
    
    // Verificar inten√ß√µes espec√≠ficas primeiro (mais espec√≠ficas primeiro)
    for (const [intent, keywords] of Object.entries(this.INTENT_KEYWORDS)) {
      for (const keyword of keywords) {
        if (lowerMessage.includes(keyword)) {
          return {
            name: intent,
            confidence: 0.8,
            entities: this.extractEntities(message),
            requiresAction: intent.startsWith('APPOINTMENT_') || intent === 'EMERGENCY',
            category: this.mapIntentToCategory(intent)
          };
        }
      }
    }

    return {
      name: 'UNCLEAR',
      confidence: 0.3,
      entities: {},
      requiresAction: false,
      category: 'conversation'
    };
  }

  static extractEntities(message) {
    const entities = {};
    
    // EXTRA√á√ÉO DE NOMES - PADR√ïES ROBUSTOS
    const namePatterns = [
      /(?:meu nome √©|sou o|sou a|me chamo|chamo-me)\s+([a-zA-Z√Ä-√ø\s]+?)(?:\s|,|\.|$)/i,
      /(?:eu sou|sou)\s+([a-zA-Z√Ä-√ø\s]+?)(?:\s|,|\.|$)/i,
      /(?:nome|chamo)\s+([a-zA-Z√Ä-√ø\s]+?)(?:\s|,|\.|$)/i,
      /(?:chamo-me|me chamo)\s+([a-zA-Z√Ä-√ø\s]+?)(?:\s|,|\.|$)/i,
      /(?:sou o|sou a)\s+([a-zA-Z√Ä-√ø\s]+?)(?:\s|,|\.|$)/i
    ];
    
    for (const pattern of namePatterns) {
      const match = message.match(pattern);
      if (match) {
        entities.name = match[1].trim();
        break;
      }
    }

    // EXTRA√á√ÉO DE DATAS
    const datePatterns = [
      /(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
      /(\d{1,2} de [a-z]+)/i,
      /(?:dia|data)\s+(\d{1,2})/i,
      /(?:dia|data)\s+(\d{1,2}\/\d{1,2})/i
    ];
    
    for (const pattern of datePatterns) {
      const match = message.match(pattern);
      if (match) {
        entities.date = match[1];
        break;
      }
    }

    // EXTRA√á√ÉO DE HOR√ÅRIOS
    const timePatterns = [
      /(\d{1,2}:\d{2})/i,
      /(\d{1,2}h\s*\d{0,2})/i,
      /(?:√†s|as)\s+(\d{1,2}:\d{2})/i
    ];
    
    for (const pattern of timePatterns) {
      const match = message.match(pattern);
      if (match) {
        entities.time = match[1];
        break;
      }
    }

    // EXTRA√á√ÉO DE ESPECIALIDADES M√âDICAS
    const specialties = [
      'cardiologia', 'dermatologia', 'ginecologia', 'ortopedia', 'pediatria',
      'neurologia', 'psiquiatria', 'oftalmologia', 'otorrinolaringologia',
      'urologia', 'gastroenterologia', 'endocrinologia', 'reumatologia'
    ];
    
    for (const specialty of specialties) {
      if (message.toLowerCase().includes(specialty)) {
        entities.specialty = specialty;
        break;
      }
    }

    return entities;
  }

  static mapIntentToCategory(intent) {
    if (intent.startsWith('APPOINTMENT_')) return 'appointment';
    if (intent.startsWith('INFO_')) return 'information';
    if (intent === 'EMERGENCY' || intent === 'URGENT_APPOINTMENT') return 'emergency';
    if (intent === 'HUMAN_HANDOFF' || intent === 'COMPLAINT') return 'support';
    if (intent.includes('NAME_') || intent.includes('BOT_')) return 'conversation';
    if (intent === 'GREETING' || intent === 'FAREWELL' || intent === 'THANKS' || intent === 'HOW_ARE_YOU') return 'conversation';
    return 'conversation';
  }
}

module.exports = IntentRecognitionService;
EOF

# 3. MELHORAR SERVI√áO AI PRINCIPAL COM APRESENTA√á√ÉO AUTOM√ÅTICA
cat > /root/atendeai-lify-backend/src/services/ai/aiService.js << 'EOF'
const ConversationMemoryService = require('./conversationMemoryService');
const IntentRecognitionService = require('./intentRecognitionService');

class AIService {
  constructor() {
    this.config = {
      models: {
        primary: 'gpt-4o',
        fallback: 'gpt-3.5-turbo'
      }
    };
  }

  async processMessage(message, phoneNumber, clinicId) {
    try {
      console.log(`üß† [AI] Processando mensagem: "${message}" de ${phoneNumber}`);
      
      // Carregar mem√≥ria da conversa
      const memory = await ConversationMemoryService.loadMemory(phoneNumber);
      
      // Verificar se deve se apresentar
      const shouldIntroduce = await ConversationMemoryService.shouldIntroduceSelf(phoneNumber);
      const context = await ConversationMemoryService.getConversationContext(phoneNumber);
      
      console.log(`üéØ [AI] Contexto: Primeira conversa: ${context.isFirstConversation}, Dias desde √∫ltima: ${context.daysSinceLastInteraction}`);
      
      // Reconhecer inten√ß√£o
      const intent = await IntentRecognitionService.recognizeIntent(message);
      
      console.log(`üéØ [AI] Inten√ß√£o detectada: ${intent.name} (confian√ßa: ${intent.confidence})`);
      console.log(`üîç [AI] Entidades extra√≠das:`, intent.entities);
      
      // Salvar nome na mem√≥ria se extra√≠do
      if (intent.entities.name && !memory.userProfile.name) {
        await ConversationMemoryService.setUserName(phoneNumber, intent.entities.name);
        console.log(`üíæ [AI] Nome salvo na mem√≥ria: ${intent.entities.name}`);
      }
      
      // Gerar resposta baseada na inten√ß√£o
      const response = await this.generateResponse(message, intent, memory, clinicId, shouldIntroduce, context);
      
      // Salvar intera√ß√£o
      await ConversationMemoryService.addInteraction(
        phoneNumber,
        message,
        response.response,
        intent.name
      );

      console.log(`ü§ñ [AI] Resposta gerada: "${response.response}"`);

      return {
        response: response.response,
        intent: intent.name,
        confidence: intent.confidence,
        entities: intent.entities,
        context: memory.context
      };
    } catch (error) {
      console.error('‚ùå [AI] Erro no processamento:', error);
      return {
        response: 'Desculpe, estou com dificuldades t√©cnicas. Pode tentar novamente?',
        intent: 'ERROR',
        confidence: 0,
        entities: {},
        context: {}
      };
    }
  }

  async generateResponse(message, intent, memory, clinicId, shouldIntroduce, context) {
    console.log(`üéØ [AI] Gerando resposta para inten√ß√£o: ${intent.name}`);
    
    // APRESENTA√á√ÉO AUTOM√ÅTICA
    if (shouldIntroduce && intent.name === 'GREETING') {
      return this.generateIntroductionResponse(context);
    }
    
    // Respostas baseadas em inten√ß√£o
    switch (intent.name) {
      case 'APPOINTMENT_CREATE':
        return {
          response: this.generateAppointmentResponse(intent, memory)
        };
      
      case 'APPOINTMENT_RESCHEDULE':
        return {
          response: 'Entendo que voc√™ quer remarcar sua consulta. Pode me informar qual consulta e qual nova data/hor√°rio voc√™ prefere?'
        };
      
      case 'APPOINTMENT_CANCEL':
        return {
          response: 'Vou ajud√°-lo a cancelar sua consulta. Pode me informar qual consulta voc√™ gostaria de cancelar?'
        };
      
      case 'INFO_HOURS':
        return {
          response: 'Nossos hor√°rios de funcionamento s√£o: Segunda a Sexta das 8h √†s 18h, S√°bados das 8h √†s 12h. Gostaria de agendar um hor√°rio?'
        };
      
      case 'INFO_LOCATION':
        return {
          response: 'Estamos localizados na Rua das Flores, 123 - Centro. Fica pr√≥ximo √† Pra√ßa Central. Precisa de mais informa√ß√µes?'
        };
      
      case 'INFO_SERVICES':
        return {
          response: 'Oferecemos as seguintes especialidades: Cardiologia, Dermatologia, Ginecologia, Ortopedia, Pediatria, Neurologia, Psiquiatria e muito mais! Qual especialidade te interessa?'
        };
      
      case 'GREETING':
        const userName = memory.userProfile.name || intent.entities.name;
        if (userName) {
          return {
            response: `Ol√° ${userName}! √â um prazer conversar com voc√™ novamente. Como posso ajudar hoje?`
          };
        }
        return {
          response: 'Ol√°! Seja bem-vindo √† nossa cl√≠nica. Sou o assistente virtual e estou aqui para ajudar. Como posso ser √∫til?'
        };
      
      case 'NAME_QUESTION':
        const storedName = memory.userProfile.name;
        if (storedName) {
          return {
            response: `Seu nome √© ${storedName}! üòä`
          };
        } else {
          return {
            response: 'Ainda n√£o sei seu nome. Pode me dizer como voc√™ se chama?'
          };
        }
      
      case 'BOT_NAME_QUESTION':
        return {
          response: 'Meu nome √© AtendeAI! Sou o assistente virtual da cl√≠nica, criado para ajudar com informa√ß√µes e agendamentos. üòä'
        };
      
      case 'BOT_CAPABILITIES':
        return {
          response: 'Posso ajudar voc√™ com: üìã Agendamento de consultas, üïê Hor√°rios de funcionamento, üìç Localiza√ß√£o da cl√≠nica, üë®‚Äç‚öïÔ∏è Informa√ß√µes sobre especialidades m√©dicas, üí∞ Pre√ßos e conv√™nios, e muito mais! O que voc√™ gostaria de saber?'
        };
      
      case 'HOW_ARE_YOU':
        return {
          response: 'Tudo bem, obrigado por perguntar! Estou funcionando perfeitamente e pronto para ajudar. E voc√™, como est√°? üòä'
        };
      
      case 'THANKS':
        return {
          response: 'Por nada! Fico feliz em poder ajudar. Se precisar de mais alguma coisa, √© s√≥ falar! üòä'
        };
      
      case 'FAREWELL':
        return {
          response: 'At√© logo! Foi um prazer ajud√°-lo. Se precisar de mais alguma coisa, estarei aqui! üëã'
        };
      
      case 'EMERGENCY':
        return {
          response: 'üö® EMERG√äNCIA: Para casos urgentes, ligue imediatamente para 192 (SAMU) ou v√° ao hospital mais pr√≥ximo. N√£o posso atender emerg√™ncias m√©dicas.'
        };
      
      case 'HUMAN_HANDOFF':
        return {
          response: 'Entendo que voc√™ gostaria de falar com um atendente humano. Vou transferir voc√™ agora. Aguarde um momento, por favor.'
        };
      
      default:
        return {
          response: 'Entendo sua mensagem. Como posso ajud√°-lo com informa√ß√µes sobre nossa cl√≠nica ou agendamento de consultas?'
        };
    }
  }

  generateIntroductionResponse(context) {
    if (context.isFirstConversation) {
      return {
        response: `Ol√°! üëã Sou o AtendeAI, o assistente virtual da cl√≠nica. √â um prazer conhec√™-lo! 

Posso ajud√°-lo com:
üìã Agendamento de consultas
üïê Hor√°rios de funcionamento  
üìç Localiza√ß√£o da cl√≠nica
üë®‚Äç‚öïÔ∏è Informa√ß√µes sobre especialidades
üí∞ Pre√ßos e conv√™nios

Como posso ser √∫til hoje? üòä`
      };
    } else if (context.daysSinceLastInteraction > 3) {
      return {
        response: `Ol√°! üëã Que bom v√™-lo novamente! 

Faz ${context.daysSinceLastInteraction} dias que n√£o conversamos. Como posso ajud√°-lo hoje? 

Posso auxiliar com agendamentos, informa√ß√µes sobre a cl√≠nica ou qualquer outra d√∫vida que voc√™ tenha! üòä`
      };
    } else {
      return {
        response: 'Ol√°! Seja bem-vindo de volta! Como posso ajud√°-lo hoje? üòä'
      };
    }
  }

  generateAppointmentResponse(intent, memory) {
    const userName = intent.entities.name || memory.userProfile.name;
    
    if (userName) {
      return `Ol√° ${userName}! Fico feliz em ajudar com o agendamento. 

Para qual especialidade voc√™ gostaria de marcar? Temos disponibilidade para:
ü´Ä Cardiologia
ü©∫ Dermatologia  
üë©‚Äç‚öïÔ∏è Ginecologia
ü¶¥ Ortopedia
üë∂ Pediatria
üß† Neurologia
üß† Psiquiatria
üëÅÔ∏è Oftalmologia

Qual especialidade te interessa?`;
    }
    
    return `Perfeito! Vou ajud√°-lo com o agendamento. 

Primeiro, preciso saber seu nome. Pode me informar como voc√™ se chama?

Depois posso te ajudar a escolher a especialidade e hor√°rio ideal! üòä`;
  }
}

module.exports = new AIService();
EOF

# Reiniciar o servi√ßo
pm2 restart atendeai-backend

echo "‚úÖ SISTEMA AI ROBUSTO IMPLEMENTADO!"
echo "üß† Novas funcionalidades:"
echo "   - Apresenta√ß√£o autom√°tica para primeiras conversas"
echo "   - Apresenta√ß√£o para conversas ap√≥s 3+ dias"
echo "   - 25+ inten√ß√µes para conversa√ß√£o natural"
echo "   - Extraction de entidades robusta"
echo "   - Mem√≥ria avan√ßada com contexto"
echo "   - Respostas personalizadas e humanizadas"
echo "   - Detec√ß√£o de emerg√™ncias"
echo "   - Suporte a m√∫ltiplas especialidades"

# Verificar status
sleep 3
curl -s http://localhost:3001/health
echo ""
curl -s http://localhost:3001/webhook/whatsapp-meta/test
echo ""

echo "üéØ TESTE: Agora teste estas mensagens:"
echo "üì± 'Ol√°' (primeira vez)"
echo "üì± 'Me chamo Lucas'"
echo "üì± 'Qual meu nome?'"
echo "üì± 'Qual seu nome?'"
echo "üì± 'O que voc√™ faz?'"
echo "üì± 'Tudo bem?'"
echo "ü§ñ O sistema agora deve responder de forma muito mais inteligente e humanizada!"
EOF 